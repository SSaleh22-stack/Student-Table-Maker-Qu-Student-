<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìö Qu Student - Extract Courses</title>
  <link rel="icon" type="image/png" href="/icon-192.png">
  <script>
    // Bookmarklet code
    var bookmarkletCode = `javascript:(function() {'use strict'; var parseSingleTimeSlot, parseTimeSlots, extractCoursesFromPage; parseSingleTimeSlot = function(slotText, dayMap) {if (!slotText) return null;const dayMapLocal = dayMap || { 1: 'Sun', 2: 'Mon', 3: 'Tue', 4: 'Wed', 5: 'Thu' }; const dayNumbersMatch = slotText.match(/^\\s*((?:\\d+\\s*)+)/);if (!dayNumbersMatch) return null;const dayNumbers = dayNumbersMatch[1].trim().split(/\\s+/).map(n => parseInt(n)).filter(n => !isNaN(n));const days = dayNumbers.map(n => dayMapLocal[n]).filter(Boolean);if (days.length === 0) return null; const timeMatch = slotText.match(/@t\\s+(\\d{1,2}):(\\d{2})\\s*([ÿµŸÖ])?\\s*-\\s*(\\d{1,2}):(\\d{2})\\s*([ÿµŸÖ])?/i);if (!timeMatch) return null;let startHour = parseInt(timeMatch[1]);const startMin = timeMatch[2];const startPeriod = timeMatch[3];let endHour = parseInt(timeMatch[4]);const endMin = timeMatch[5];const endPeriod = timeMatch[6]; if (startPeriod === 'ŸÖ' && startHour !== 12) startHour += 12;if (startPeriod === 'ÿµ' && startHour === 12) startHour = 0;if (endPeriod === 'ŸÖ' && endHour !== 12) endHour += 12;if (endPeriod === 'ÿµ' && endHour === 12) endHour = 0; const locationMatch = slotText.match(/@r\\s+(.+?)(?:\\s*$|@n|@t|@)/);const location = locationMatch ? locationMatch[1].trim() : undefined;return {days: days,startTime: \`\${startHour.toString().padStart(2, '0')}:\${startMin}\`,endTime: \`\${endHour.toString().padStart(2, '0')}:\${endMin}\`,location: location};}; parseTimeSlots = function(input) {const slots = [];if (!input) return slots; if (input.includes('@n')) {const dayMap = { 1: 'Sun', 2: 'Mon', 3: 'Tue', 4: 'Wed', 5: 'Thu' };const parts = input.split(/@n\\s*/).filter(p => p.trim());for (const part of parts) {const slot = parseSingleTimeSlot(part.trim(), dayMap);if (slot && slot.days.length > 0) {slots.push(slot);}}return slots;} const pattern = /((?:\\d+\\s*)+)@t\\s+(\\d{1,2}):(\\d{2})\\s*([ÿµŸÖ])?\\s*-\\s*(\\d{1,2}):(\\d{2})\\s*([ÿµŸÖ])?/gi;const matches = input.matchAll(pattern);const dayMap = { 1: 'Sun', 2: 'Mon', 3: 'Tue', 4: 'Wed', 5: 'Thu' };for (const match of matches) {const slot = parseSingleTimeSlot(match[0], dayMap);if (slot && slot.days.length > 0) {slots.push(slot);}} if (slots.length === 0) {const slot = parseSingleTimeSlot(input, dayMap);if (slot && slot.days.length > 0) {slots.push(slot);}}return slots;}; extractCoursesFromPage = function() {const courses = [];let skippedRows = 0;let errorRows = 0;try {console.log('Extracting courses from QU portal:', window.location.href); const rows = document.querySelectorAll('tbody tr[class^=\"ROW\"]');console.log(\`Found \${rows.length} course rows\`);rows.forEach((row, index) => {try {const cells = row.querySelectorAll('td');if (cells.length < 8) {console.warn(\`Row \${index} has insufficient cells (\${cells.length}), expected 8\`);skippedRows++;return;} const code = (cells[0]?.textContent?.trim()) || \`COURSE-\${index}\`;const name = (cells[1]?.textContent?.trim()) || 'Unknown Course';const section = (cells[3]?.textContent?.trim()) || '01';const classTypeText = (cells[4]?.textContent?.trim()) || ''; let classType;if (classTypeText.includes('ŸÜÿ∏ÿ±Ÿä') || classTypeText.toLowerCase().includes('theoretical')) {classType = 'theoretical';} else if (classTypeText.includes('ÿπŸÖŸÑŸä') || classTypeText.toLowerCase().includes('practical')) {classType = 'practical';} else if (classTypeText.includes('ÿ™ŸÖÿ±ŸäŸÜ') || classTypeText.toLowerCase().includes('exercise')) {classType = 'exercise';} const statusText = (cells[6]?.textContent?.trim()) || '';const status = statusText.includes('ŸÖÿ∫ŸÑŸÇÿ©') || statusText.toLowerCase().includes('closed')? 'closed': statusText.includes('ŸÖŸÅÿ™Ÿàÿ≠ÿ©') || statusText.toLowerCase().includes('open')? 'open': undefined; const lastCell = cells[7];let instructor = '';let examPeriod = '';let timeSlots = [];if (lastCell) {const instructorInput = lastCell.querySelector('input[name*=\"instructor\"]');if (instructorInput) {instructor = instructorInput.value.trim();}const examInput = lastCell.querySelector('input[name*=\"examPeriod\"]');if (examInput) {examPeriod = examInput.value.trim();} const sectionInput = lastCell.querySelector('input[name*=\"section\"]');if (sectionInput && sectionInput.value) {try {timeSlots = parseTimeSlots(sectionInput.value);} catch (parseError) {console.warn(\`Error parsing time slots for row \${index}:\`, parseError, 'Section value:', sectionInput.value);timeSlots = [];}}} let course;if (timeSlots.length > 0) { const allDays = new Set();timeSlots.forEach(ts => ts.days.forEach(d => allDays.add(d)));const firstSlot = timeSlots[0];course = {id: \`\${code}-\${section}-\${index}\`,code: code,name: name,section: section,days: Array.from(allDays),startTime: firstSlot.startTime,endTime: firstSlot.endTime,location: firstSlot.location || undefined,timeSlots: timeSlots.length > 1 ? timeSlots.map(ts => ({days: ts.days,startTime: ts.startTime,endTime: ts.endTime,location: ts.location || undefined})) : undefined,instructor: instructor || undefined,status: status,classType: classType,finalExam: examPeriod ? {day: firstSlot.days[0] || 'Sun',startTime: '08:00',endTime: '10:00',date: examPeriod} : undefined};} else { course = {id: \`\${code}-\${section}-\${index}\`,code: code,name: name,section: section,days: ['Sun'],startTime: '08:00',endTime: '09:30',instructor: instructor || undefined,status: status,classType: classType,finalExam: examPeriod ? {day: 'Sun',startTime: '08:00',endTime: '10:00',date: examPeriod} : undefined};}courses.push(course);} catch (error) {console.error(\`Error parsing course row \${index}:\`, error, row);errorRows++;}});console.log(\`Successfully extracted \${courses.length} courses from \${rows.length} rows (\${skippedRows} skipped, \${errorRows} errors)\`);if (courses.length < rows.length * 0.5) {console.warn(\`‚ö†Ô∏è Warning: Only extracted \${courses.length} courses from \${rows.length} rows. This might indicate a parsing issue.\`);}return courses;} catch (error) {console.error('Error extracting courses:', error);return [];}}; try {const courses = extractCoursesFromPage();if (!courses || courses.length === 0) {alert('No courses found on this page. Make sure you are on the QU student portal course page and that courses are visible.');console.error('No courses extracted. Check the page structure.');return;} const validCourses = courses.filter(c => c && c.code && c.name);if (validCourses.length === 0) {alert('Error: Extracted courses are invalid. Check console for details.');console.error('Invalid courses:', courses);return;} const coursesJson = JSON.stringify(validCourses);const encodedCourses = encodeURIComponent(coursesJson); try {localStorage.setItem('qu-student-courses', coursesJson);localStorage.setItem('qu-student-courses-timestamp', Date.now().toString());console.log('Saved '+validCourses.length+' courses to localStorage');} catch (storageError) {console.warn('Could not save to localStorage (cross-origin):', storageError); } const message = '‚úÖ Successfully extracted '+validCourses.length+' courses!\\n\\nOpening web app...';alert(message); const defaultUrl = 'https://SSaleh22-stack.github.io/Student-Table-Maker-Qu-Student-/'; const webAppUrl = prompt('Enter your Qu Student web app URL:', defaultUrl) || defaultUrl;const urlWithData = webAppUrl.trim() + '#courses=' + encodedCourses;console.log('Opening web app with courses data in URL');window.open(urlWithData, '_blank');} catch (error) {console.error('Bookmarklet error:', error);console.error('Error stack:', error.stack);alert('Error extracting courses: ' + (error.message || String(error)));}})();`;

    // Check if we came from QU portal
    if (document.referrer && document.referrer.includes('stu-gate.qu.edu.sa')) {
      // Immediately redirect to the javascript: URL to execute on previous page
      // But this won't work because we're already on a different page
      // So we'll go back first, then execute
      window.history.back();
      
      // After going back, we need to execute the code
      // We'll use sessionStorage to pass the code
      sessionStorage.setItem('qu-bookmarklet-execute', bookmarkletCode.replace('javascript:', ''));
      
      // The QU portal page won't have our script, so we need a different approach
      // Let's use a meta refresh to go back and then inject
      setTimeout(function() {
        // Try to inject script into the previous page
        // But this won't work due to cross-origin
        // So we'll need to provide a user script or use a different method
      }, 100);
    } else if (!document.referrer || !document.referrer.includes('stu-gate.qu.edu.sa')) {
      // Not from QU portal - show instructions
      document.body.innerHTML = '<div style="padding: 2rem; text-align: center; font-family: sans-serif;"><h1>üìö Qu Student</h1><p style="color: #666; margin: 1rem 0;">‚ö†Ô∏è Please go to the QU student portal course page first, then click this bookmark.</p><p><a href="https://stu-gate.qu.edu.sa" style="color: #667eea; text-decoration: none; font-weight: 600;">Go to QU Portal ‚Üí</a></p></div>';
    }
  </script>
</head>
<body>
  <p style="text-align: center; padding: 2rem; font-family: sans-serif;">Executing bookmarklet...</p>
  <script>
    // Since we can't inject into QU portal directly, the simplest solution is:
    // Make the bookmarklet link directly to the javascript: URL
    // But we want title/icon, so we'll use this page as an intermediary
    
    // The best solution: Update bookmarklet.html to link directly to javascript: URL
    // But preserve title/icon by using this page's title/icon when dragged
    
    // For now, let's make it work by redirecting to javascript: URL immediately
    if (document.referrer && document.referrer.includes('stu-gate.qu.edu.sa')) {
      // Redirect to javascript: URL - this should execute on the previous page
      // But browsers block this for security
      // So we'll need to use a different approach
      
      // Final solution: Make bookmarklet.html link directly to javascript: URL
      // The title and icon will come from the page when dragged
      // But when clicked, it will execute the javascript: URL directly
    }
  </script>
</body>
</html>
