<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu Student - Bookmarklet Setup</title>
  <link rel="icon" type="image/png" href="/icon-192.png">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
      line-height: 1.6;
      text-align: center;
    }
    .setup-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin: 2rem 0;
    }
    .setup-btn {
      display: inline-block;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      margin: 1rem 0;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      transition: all 0.3s;
    }
    .setup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    .setup-btn:active {
      transform: translateY(0);
    }
    .instructions {
      background: #f0fff4;
      border-left: 4px solid #48bb78;
      padding: 1rem;
      margin: 1rem 0;
      text-align: left;
      border-radius: 6px;
    }
    .success-message {
      background: #c6f6d5;
      color: #22543d;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      display: none;
    }
    .bookmarklet-button {
      display: inline-block;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 8px;
      margin: 0.5rem;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: grab;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }
    .bookmarklet-button:hover {
      background: linear-gradient(135deg, #5568d3 0%, #6a3d8a 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    .bookmarklet-button:active {
      cursor: grabbing;
      transform: translateY(0);
    }
    h1 { color: #2d3748; }
    .highlight {
      background: #fff3cd;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>ðŸ“š Qu Student - Bookmarklet Setup</h1>
  
  <div class="setup-container">
    <h2>Quick Setup</h2>
    <p><strong>Drag the button below to your bookmarks bar:</strong></p>
    <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
      <strong>First:</strong> Press <kbd style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">Ctrl+Shift+B</kbd> (or <kbd style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">Cmd+Shift+B</kbd> on Mac) to show your bookmarks bar if it's hidden.
    </p>
    <a href="/extract-courses.html" class="bookmarklet-button" id="bookmarkletLink" draggable="true" title="ðŸ“š Qu Student - Extract Courses">ðŸ“š Qu Student</a>
    <p style="font-size: 0.85rem; color: #888; margin-top: 0.5rem; font-style: italic;">
      ðŸ’¡ Tip: Just click and drag this button to your bookmarks bar (the bar below the address bar)
    </p>
  </div>

  <div class="instructions">
    <h3>How to Use:</h3>
    <ol style="text-align: left;">
      <li>After adding the bookmarklet, go to the QU student portal course page</li>
      <li>Click the bookmarklet from your bookmarks</li>
      <li>Wait for extraction - you'll see a success message</li>
      <li>Enter your web app URL (or use default)</li>
      <li>Courses will be automatically loaded in the web app!</li>
    </ol>
  </div>

  <script>
    // Read the bookmarklet code from bookmarklet-ready.js
    // For now, we'll use the javascript: URL directly
    // The bookmarklet code is stored in extract-courses.html, but we need it here
    // Let's fetch it or include it inline
    
    // Bookmarklet javascript: URL (minified version)
    const bookmarkletJsUrl = `javascript:(function() {'use strict'; var parseSingleTimeSlot, parseTimeSlots, extractCoursesFromPage; parseSingleTimeSlot = function(slotText, dayMap) {if (!slotText) return null;const dayMapLocal = dayMap || { 1: 'Sun', 2: 'Mon', 3: 'Tue', 4: 'Wed', 5: 'Thu' }; const dayNumbersMatch = slotText.match(/^\\s*((?:\\d+\\s*)+)/);if (!dayNumbersMatch) return null;const dayNumbers = dayNumbersMatch[1].trim().split(/\\s+/).map(n => parseInt(n)).filter(n => !isNaN(n));const days = dayNumbers.map(n => dayMapLocal[n]).filter(Boolean);if (days.length === 0) return null; const timeMatch = slotText.match(/@t\\s+(\\d{1,2}):(\\d{2})\\s*([ØµÙ…])?\\s*-\\s*(\\d{1,2}):(\\d{2})\\s*([ØµÙ…])?/i);if (!timeMatch) return null;let startHour = parseInt(timeMatch[1]);const startMin = timeMatch[2];const startPeriod = timeMatch[3];let endHour = parseInt(timeMatch[4]);const endMin = timeMatch[5];const endPeriod = timeMatch[6]; if (startPeriod === 'Ù…' && startHour !== 12) startHour += 12;if (startPeriod === 'Øµ' && startHour === 12) startHour = 0;if (endPeriod === 'Ù…' && endHour !== 12) endHour += 12;if (endPeriod === 'Øµ' && endHour === 12) endHour = 0; const locationMatch = slotText.match(/@r\\s+(.+?)(?:\\s*$|@n|@t|@)/);const location = locationMatch ? locationMatch[1].trim() : undefined;return {days: days,startTime: \`\${startHour.toString().padStart(2, '0')}:\${startMin}\`,endTime: \`\${endHour.toString().padStart(2, '0')}:\${endMin}\`,location: location};}; parseTimeSlots = function(input) {const slots = [];if (!input) return slots; if (input.includes('@n')) {const dayMap = { 1: 'Sun', 2: 'Mon', 3: 'Tue', 4: 'Wed', 5: 'Thu' };const parts = input.split(/@n\\s*/).filter(p => p.trim());for (const part of parts) {const slot = parseSingleTimeSlot(part.trim(), dayMap);if (slot && slot.days.length > 0) {slots.push(slot);}}return slots;} const pattern = /((?:\\d+\\s*)+)@t\\s+(\\d{1,2}):(\\d{2})\\s*([ØµÙ…])?\\s*-\\s*(\\d{1,2}):(\\d{2})\\s*([ØµÙ…])?/gi;const matches = input.matchAll(pattern);const dayMap = { 1: 'Sun', 2: 'Mon', 3: 'Tue', 4: 'Wed', 5: 'Thu' };for (const match of matches) {const slot = parseSingleTimeSlot(match[0], dayMap);if (slot && slot.days.length > 0) {slots.push(slot);}} if (slots.length === 0) {const slot = parseSingleTimeSlot(input, dayMap);if (slot && slot.days.length > 0) {slots.push(slot);}}return slots;}; extractCoursesFromPage = function() {const courses = [];let skippedRows = 0;let errorRows = 0;try {console.log('Extracting courses from QU portal:', window.location.href); const rows = document.querySelectorAll('tbody tr[class^=\"ROW\"]');console.log(\`Found \${rows.length} course rows\`);rows.forEach((row, index) => {try {const cells = row.querySelectorAll('td');if (cells.length < 8) {console.warn(\`Row \${index} has insufficient cells (\${cells.length}), expected 8\`);skippedRows++;return;} const code = (cells[0]?.textContent?.trim()) || \`COURSE-\${index}\`;const name = (cells[1]?.textContent?.trim()) || 'Unknown Course';const section = (cells[3]?.textContent?.trim()) || '01';const classTypeText = (cells[4]?.textContent?.trim()) || ''; let classType;if (classTypeText.includes('Ù†Ø¸Ø±ÙŠ') || classTypeText.toLowerCase().includes('theoretical')) {classType = 'theoretical';} else if (classTypeText.includes('Ø¹Ù…Ù„ÙŠ') || classTypeText.toLowerCase().includes('practical')) {classType = 'practical';} else if (classTypeText.includes('ØªÙ…Ø±ÙŠÙ†') || classTypeText.toLowerCase().includes('exercise')) {classType = 'exercise';} const statusText = (cells[6]?.textContent?.trim()) || '';const status = statusText.includes('Ù…ØºÙ„Ù‚Ø©') || statusText.toLowerCase().includes('closed')? 'closed': statusText.includes('Ù…ÙØªÙˆØ­Ø©') || statusText.toLowerCase().includes('open')? 'open': undefined; const lastCell = cells[7];let instructor = '';let examPeriod = '';let timeSlots = [];if (lastCell) {const instructorInput = lastCell.querySelector('input[name*=\"instructor\"]');if (instructorInput) {instructor = instructorInput.value.trim();}const examInput = lastCell.querySelector('input[name*=\"examPeriod\"]');if (examInput) {examPeriod = examInput.value.trim();} const sectionInput = lastCell.querySelector('input[name*=\"section\"]');if (sectionInput && sectionInput.value) {try {timeSlots = parseTimeSlots(sectionInput.value);} catch (parseError) {console.warn(\`Error parsing time slots for row \${index}:\`, parseError, 'Section value:', sectionInput.value);timeSlots = [];}}} let course;if (timeSlots.length > 0) { const allDays = new Set();timeSlots.forEach(ts => ts.days.forEach(d => allDays.add(d)));const firstSlot = timeSlots[0];course = {id: \`\${code}-\${section}-\${index}\`,code: code,name: name,section: section,days: Array.from(allDays),startTime: firstSlot.startTime,endTime: firstSlot.endTime,location: firstSlot.location || undefined,timeSlots: timeSlots.length > 1 ? timeSlots.map(ts => ({days: ts.days,startTime: ts.startTime,endTime: ts.endTime,location: ts.location || undefined})) : undefined,instructor: instructor || undefined,status: status,classType: classType,finalExam: examPeriod ? {day: firstSlot.days[0] || 'Sun',startTime: '08:00',endTime: '10:00',date: examPeriod} : undefined};} else { course = {id: \`\${code}-\${section}-\${index}\`,code: code,name: name,section: section,days: ['Sun'],startTime: '08:00',endTime: '09:30',instructor: instructor || undefined,status: status,classType: classType,finalExam: examPeriod ? {day: 'Sun',startTime: '08:00',endTime: '10:00',date: examPeriod} : undefined};}courses.push(course);} catch (error) {console.error(\`Error parsing course row \${index}:\`, error, row);errorRows++;}});console.log(\`Successfully extracted \${courses.length} courses from \${rows.length} rows (\${skippedRows} skipped, \${errorRows} errors)\`);if (courses.length < rows.length * 0.5) {console.warn(\`âš ï¸ Warning: Only extracted \${courses.length} courses from \${rows.length} rows. This might indicate a parsing issue.\`);}return courses;} catch (error) {console.error('Error extracting courses:', error);return [];}}; try {const courses = extractCoursesFromPage();if (!courses || courses.length === 0) {alert('No courses found on this page. Make sure you are on the QU student portal course page and that courses are visible.');console.error('No courses extracted. Check the page structure.');return;} const validCourses = courses.filter(c => c && c.code && c.name);if (validCourses.length === 0) {alert('Error: Extracted courses are invalid. Check console for details.');console.error('Invalid courses:', courses);return;} const coursesJson = JSON.stringify(validCourses);const encodedCourses = encodeURIComponent(coursesJson); try {localStorage.setItem('qu-student-courses', coursesJson);localStorage.setItem('qu-student-courses-timestamp', Date.now().toString());console.log('Saved '+validCourses.length+' courses to localStorage');} catch (storageError) {console.warn('Could not save to localStorage (cross-origin):', storageError); } const message = 'âœ… Successfully extracted '+validCourses.length+' courses!\\n\\nOpening web app...';alert(message); const defaultUrl = 'http://localhost:3000'; const webAppUrl = prompt('Enter your Qu Student web app URL:', defaultUrl) || defaultUrl;const urlWithData = webAppUrl.trim() + '#courses=' + encodedCourses;console.log('Opening web app with courses data in URL');window.open(urlWithData, '_blank');} catch (error) {console.error('Bookmarklet error:', error);console.error('Error stack:', error.stack);alert('Error extracting courses: ' + (error.message || String(error)));}})();`;

    // Initialize drag functionality on page load
    window.addEventListener('DOMContentLoaded', function() {
      const bookmarkletButton = document.getElementById('bookmarkletLink');
      if (bookmarkletButton) {
        // Set href to the javascript: URL
        bookmarkletButton.href = bookmarkletJsUrl;
        bookmarkletButton.draggable = true;
        bookmarkletButton.style.cursor = 'grab';
        
        bookmarkletButton.addEventListener('dragstart', function(e) {
          // Set the dataTransfer with the javascript: URL
          e.dataTransfer.setData('text/uri-list', bookmarkletJsUrl);
          e.dataTransfer.setData('text/plain', bookmarkletJsUrl);
          e.dataTransfer.effectAllowed = 'copy';
          this.style.cursor = 'grabbing';
        });
        
        bookmarkletButton.addEventListener('dragend', function() {
          this.style.cursor = 'grab';
        });
        
        // Prevent clicking - only allow dragging
        bookmarkletButton.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }, true); // Use capture phase to catch early
        
      }
    });
  </script>
</body>
</html>
