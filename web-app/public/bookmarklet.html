<!DOCTYPE html>
<html lang="en" dir="auto">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu Student - Bookmarklet Setup | Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</title>
  <link rel="icon" type="image/png" href="/icon-192.png">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      padding: 1rem;
      line-height: 1.6;
      text-align: center;
    }
    .setup-container {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin: 2rem 0;
    }
    .setup-btn {
      display: inline-block;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 1.1rem;
      margin: 1rem 0;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      transition: all 0.3s;
    }
    .setup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    .setup-btn:active {
      transform: translateY(0);
    }
    .instructions {
      background: #f0fff4;
      border-left: 4px solid #48bb78;
      padding: 1rem;
      margin: 1rem 0;
      text-align: left;
      border-radius: 6px;
    }
    [dir="rtl"] .instructions {
      border-left: none;
      border-right: 4px solid #48bb78;
      text-align: right;
    }
    .success-message {
      background: #c6f6d5;
      color: #22543d;
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
      display: none;
    }
    .bookmarklet-button {
      display: inline-block;
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 8px;
      margin: 0.5rem;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: grab;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
    }
    .bookmarklet-button:hover {
      background: linear-gradient(135deg, #5568d3 0%, #6a3d8a 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
    }
    .bookmarklet-button:active {
      cursor: grabbing;
      transform: translateY(0);
    }
    h1 { color: #2d3748; }
    .highlight {
      background: #fff3cd;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š Qu Student - Bookmarklet Setup | Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©</h1>
  
  <div class="setup-container">
    <h2 class="lang-en">Quick Setup</h2>
    <h2 class="lang-ar" style="display: none;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø±ÙŠØ¹</h2>
    <p class="lang-en"><strong>Drag the button below to your bookmarks bar:</strong></p>
    <p class="lang-ar" style="display: none;"><strong>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ø¥Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©:</strong></p>
    <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;" class="lang-en">
      <strong>First:</strong> Press <kbd style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">Ctrl+Shift+B</kbd> (or <kbd style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">Cmd+Shift+B</kbd> on Mac) to show your bookmarks bar if it's hidden.
    </p>
    <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem; display: none;" class="lang-ar">
      <strong>Ø£ÙˆÙ„Ø§Ù‹:</strong> Ø§Ø¶ØºØ· <kbd style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">Ctrl+Shift+B</kbd> (Ø£Ùˆ <kbd style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 3px;">Cmd+Shift+B</kbd> Ø¹Ù„Ù‰ Mac) Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ÙÙŠØ§Ù‹.
    </p>
    <a href="javascript:void(0)" class="bookmarklet-button" id="bookmarkletLink" draggable="true" title="ğŸ“š Qu Student - Extract Courses | Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª">ğŸ“š Qu Student</a>
    <p style="font-size: 0.85rem; color: #888; margin-top: 0.5rem; font-style: italic;" class="lang-en">
      ğŸ’¡ Tip: Just click and drag this button to your bookmarks bar (the bar below the address bar)
    </p>
    <p style="font-size: 0.85rem; color: #888; margin-top: 0.5rem; font-style: italic; display: none;" class="lang-ar">
      ğŸ’¡ Ù†ØµÙŠØ­Ø©: ÙÙ‚Ø· Ø§Ù†Ù‚Ø± ÙˆØ§Ø³Ø­Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ø¥Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© (Ø§Ù„Ø´Ø±ÙŠØ· Ø£Ø³ÙÙ„ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†)
    </p>
  </div>

  <div class="instructions">
    <h3 class="lang-en">How to Use:</h3>
    <h3 class="lang-ar" style="display: none;">ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h3>
    <ol style="text-align: left;" class="lang-en">
      <li>After adding the bookmarklet, go to the QU student portal course page</li>
      <li>Click the bookmarklet from your bookmarks</li>
      <li>Wait for extraction - you'll see a success message</li>
      <li>Enter your web app URL (or use default)</li>
      <li>Courses will be automatically loaded in the web app!</li>
    </ol>
    <ol style="text-align: right; direction: rtl; display: none;" class="lang-ar">
      <li>Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©ØŒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª Ø§Ù„Ù…Ø·Ø±ÙˆØ­Ø© ÙÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</li>
      <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ù…Ù† Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ</li>
      <li>Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ - Ø³ØªØ±Ù‰ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­</li>
      <li>Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø±Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!</li>
    </ol>
  </div>

  <script>
    // Get language preference from web app's localStorage
    // This allows the bookmarklet setup page to use the same language as the dashboard
    const getLanguagePreference = function() {
      try {
        // Try to access localStorage from the web app (same origin)
        const saved = localStorage.getItem('qu-student-language');
        if (saved === 'en' || saved === 'ar') {
          return saved;
        }
      } catch (e) {
        // If localStorage is not accessible (cross-origin), return null
      }
      return null;
    };
    
    // Detect language and update UI
    (function() {
      // First, try to get language from web app's localStorage
      const savedLang = getLanguagePreference();
      let isArabic = false;
      
      if (savedLang === 'ar') {
        isArabic = true;
      } else if (savedLang === 'en') {
        isArabic = false;
      } else {
        // Fall back to detecting from browser/page
        isArabic = navigator.language.startsWith('ar') || document.documentElement.lang === 'ar' || document.documentElement.dir === 'rtl';
      }
      
      if (isArabic) {
        document.documentElement.dir = 'rtl';
        document.documentElement.lang = 'ar';
        document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.lang-ar').forEach(el => el.style.display = 'block');
        // Update instructions alignment for RTL
        const instructions = document.querySelector('.instructions');
        if (instructions) {
          instructions.style.textAlign = 'right';
        }
      } else {
        document.documentElement.dir = 'ltr';
        document.documentElement.lang = 'en';
        document.querySelectorAll('.lang-en').forEach(el => el.style.display = 'block');
        document.querySelectorAll('.lang-ar').forEach(el => el.style.display = 'none');
        // Update instructions alignment for LTR
        const instructions = document.querySelector('.instructions');
        if (instructions) {
          instructions.style.textAlign = 'left';
        }
      }
    })();
    
    // Listen for storage changes to update language when it changes in the web app
    window.addEventListener('storage', function(e) {
      if (e.key === 'qu-student-language') {
        const savedLang = e.newValue;
        if (savedLang === 'ar' || savedLang === 'en') {
          const isArabic = savedLang === 'ar';
          document.documentElement.dir = isArabic ? 'rtl' : 'ltr';
          document.documentElement.lang = savedLang;
          document.querySelectorAll('.lang-en').forEach(el => el.style.display = isArabic ? 'none' : 'block');
          document.querySelectorAll('.lang-ar').forEach(el => el.style.display = isArabic ? 'block' : 'none');
          const instructions = document.querySelector('.instructions');
          if (instructions) {
            instructions.style.textAlign = isArabic ? 'right' : 'left';
          }
        }
      }
    });
    
    // Function to load standalone bookmarklet code and update bookmarklet
    async function updateBookmarkletCode() {
      // Use loader approach - always load from GitHub Pages
      const languagePref = getLanguagePreference();
      const langCode = languagePref === 'ar' ? 'true' : (languagePref === 'en' ? 'false' : 'null');
      // Always use GitHub Pages URL for bookmarklet-code.js
      // This ensures it works from any website (QU portal, etc.)
      const githubPagesUrl = 'https://SSaleh22-stack.github.io/Student-Table-Maker-Qu-Student-/bookmarklet-code.js';
      console.log('Bookmarklet will load from GitHub Pages:', githubPagesUrl);
      // Use a more reliable loader that waits for the script to load
      // Build the bookmarklet code with proper URL handling - always use GitHub Pages URL
      // Escape the URL properly for use in JavaScript string
      const escapedUrl = githubPagesUrl.replace(/'/g, "\\'");
      return `javascript:(function(){if(window.__QU_BOOKMARKLET_LOADED__){console.log('Bookmarklet already loaded');return;}window.__QU_BOOKMARKLET_LOADED__=true;window.__QU_BOOKMARKLET_LANG__=${langCode};var githubUrl='${escapedUrl}';window.__QU_BOOKMARKLET_BASE_URL__=githubUrl;console.log('Loading bookmarklet code from:',githubUrl);var s=document.createElement('script');s.async=false;s.src=githubUrl+'?v='+Date.now();s.onload=function(){console.log('Bookmarklet code loaded successfully');};s.onerror=function(){console.error('Failed to load bookmarklet-code.js from GitHub Pages');alert('Failed to load bookmarklet. Please check your internet connection and try again.\\n\\nTried:\\n- '+githubUrl+'\\n\\nIf the problem persists, please visit the GitHub repository to report the issue.');console.error('Bookmarklet failed to load from GitHub Pages');};document.head.appendChild(s);})();`;
    }
    
    // Create initial bookmarklet code (will be updated dynamically)
    const bookmarkletLoaderCode = updateBookmarkletCode();
    
    // Use the extract-courses.html page as the bookmark target for title/logo
    // But we'll update it to use the javascript: URL when clicked
    const bookmarkletUrl = window.location.origin + window.location.pathname.replace('bookmarklet.html', 'extract-courses.html');
    
    // Listen for storage changes to update bookmarklet when language changes
    window.addEventListener('storage', function(e) {
      if (e.key === 'qu-student-language') {
        const bookmarkletButton = document.getElementById('bookmarkletLink');
        if (bookmarkletButton) {
          const bookmarkTitle = 'Qu Student';
          bookmarkletButton.href = updateBookmarkletCode();
          bookmarkletButton.title = bookmarkTitle;
          bookmarkletButton.setAttribute('title', bookmarkTitle);
        }
      }
    });
    
    // Initialize drag functionality on page load
    window.addEventListener('DOMContentLoaded', function() {
      const bookmarkletButton = document.getElementById('bookmarkletLink');
      if (bookmarkletButton) {
        // Update bookmarklet code with current language
        const currentBookmarkletCode = updateBookmarkletCode();
        
        // Get the appropriate title - use simple title for bookmark
        const bookmarkTitle = 'Qu Student';
        
        // Set href and title to the javascript: URL for direct execution
        bookmarkletButton.href = currentBookmarkletCode;
        bookmarkletButton.title = bookmarkTitle;
        bookmarkletButton.setAttribute('title', bookmarkTitle);
        bookmarkletButton.draggable = true;
        bookmarkletButton.style.cursor = 'grab';
        
        bookmarkletButton.addEventListener('dragstart', async function(e) {
          // Update bookmarklet code with current language before dragging
          const freshCode = await updateBookmarkletCode();
          // Get the appropriate title - use simple title for bookmark
          const bookmarkTitle = 'Qu Student';
          // Store original text content to restore later
          const originalText = this.textContent;
          // Update the element's text content to "Qu Student" so browsers use it as bookmark title
          this.textContent = bookmarkTitle;
          // Set the dataTransfer with the javascript: URL for direct execution
          // This allows the bookmarklet to run directly on the QU portal page
          e.dataTransfer.setData('text/uri-list', freshCode);
          // Set text/plain with just the code (URL)
          e.dataTransfer.setData('text/plain', freshCode);
          // Set text/html with the title as the link text - this is what browsers use for bookmark title
          e.dataTransfer.setData('text/html', '<a href="' + freshCode.replace(/"/g, '&quot;') + '">' + bookmarkTitle + '</a>');
          e.dataTransfer.effectAllowed = 'copy';
          this.style.cursor = 'grabbing';
          // Also update href and title immediately before drag to ensure it's correct
          this.href = freshCode;
          this.title = bookmarkTitle;
          // Force update the href and title attributes
          this.setAttribute('href', freshCode);
          this.setAttribute('title', bookmarkTitle);
          // Restore original text after drag ends
          const restoreTextHandler = function() {
            this.textContent = originalText;
            this.style.cursor = 'grab';
            this.removeEventListener('dragend', restoreTextHandler);
          };
          this.addEventListener('dragend', restoreTextHandler, { once: true });
        });
        
        // Allow clicking to copy the bookmarklet code to clipboard
        bookmarkletButton.addEventListener('click', async function(e) {
          e.preventDefault();
          e.stopPropagation();
          // Copy bookmarklet code to clipboard
          const code = await updateBookmarkletCode();
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(code).then(function() {
              const message = document.documentElement.lang === 'ar'
                ? 'ØªÙ… Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©! Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø´Ø§Ø±Ø© Ù…Ø±Ø¬Ø¹ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ„ØµÙ‚ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ¹Ù†ÙˆØ§Ù† URL.'
                : 'Bookmarklet code copied to clipboard! You can now create a new bookmark and paste this code as the URL.';
              alert(message);
            }).catch(function() {
              // Fallback: show the code in a prompt
              prompt(document.documentElement.lang === 'ar'
                ? 'Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ£Ù†Ø´Ø¦ Ø¥Ø´Ø§Ø±Ø© Ù…Ø±Ø¬Ø¹ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ¹Ù†ÙˆØ§Ù† URL:'
                : 'Copy this code and create a new bookmark with this code as the URL:', code);
            });
          } else {
            // Fallback: show the code in a prompt
            prompt(document.documentElement.lang === 'ar'
              ? 'Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ£Ù†Ø´Ø¦ Ø¥Ø´Ø§Ø±Ø© Ù…Ø±Ø¬Ø¹ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ¹Ù†ÙˆØ§Ù† URL:'
              : 'Copy this code and create a new bookmark with this code as the URL:', code);
          }
          return false;
        }, true); // Use capture phase to catch early
        
      }
    });
  </script>
</body>
</html>
